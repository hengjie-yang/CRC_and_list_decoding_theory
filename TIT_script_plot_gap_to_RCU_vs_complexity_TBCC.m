% This script is to generate the SNR gap to the RCU bound vs. E[L] plot for
% CRC-TBCC codes.
%
% Written by Hengjie Yang (hengjie.yang@ucla.edu)   03/11/21
%

clear all;
clc;


set(0,'DefaultTextFontName','Times','DefaultTextFontSize',16,...
    'DefaultAxesFontName','Times','DefaultAxesFontSize',16,...
    'DefaultLineLineWidth',1,'DefaultLineMarkerSize',7.75);
set(groot, 'defaultAxesTickLabelInterpreter','latex'); 
set(groot, 'defaultLegendInterpreter','latex');

% basic parameters
target_prob_UE = 10^(-4);
k = 64;
omega = 2;

vs = [3,4,5,6,7,8,9,10];
fileNames = cell(8, 1);
SNR_gaps = cell(8, 1);
Complexities = cell(8, 1);

path = './TCOM_sim_data/';

% v = 3
fileNames{1} = {'031521_181826_sim_data_vs_SNR_TBCC_13_17_CRC_17_k_64';...
    '031521_182025_sim_data_vs_SNR_TBCC_13_17_CRC_37_k_64';...
    '031521_182253_sim_data_vs_SNR_TBCC_13_17_CRC_55_k_64';...
    '031521_182426_sim_data_vs_SNR_TBCC_13_17_CRC_143_k_64';...
    '031521_182627_sim_data_vs_SNR_TBCC_13_17_CRC_355_k_64';...
    '031521_182813_sim_data_vs_SNR_TBCC_13_17_CRC_407_k_64';...
    '031521_183029_sim_data_vs_SNR_TBCC_13_17_CRC_1511_k_64';...
    '031521_183317_sim_data_vs_SNR_TBCC_13_17_CRC_2235_k_64'};

% v = 4
fileNames{2} = {'031521_181855_sim_data_vs_SNR_TBCC_27_31_CRC_17_k_64';...
    '031521_182036_sim_data_vs_SNR_TBCC_27_31_CRC_21_k_64';...
    '031521_182303_sim_data_vs_SNR_TBCC_27_31_CRC_63_k_64';...
    '031521_182438_sim_data_vs_SNR_TBCC_27_31_CRC_117_k_64';...
    '031521_182639_sim_data_vs_SNR_TBCC_27_31_CRC_265_k_64';...
    '031521_182827_sim_data_vs_SNR_TBCC_27_31_CRC_653_k_64';...
    '031521_183045_sim_data_vs_SNR_TBCC_27_31_CRC_1145_k_64';...
    '031521_183330_sim_data_vs_SNR_TBCC_27_31_CRC_2321_k_64'};


% v = 5
fileNames{3} = {'031521_181907_sim_data_vs_SNR_TBCC_53_75_CRC_11_k_64';...
    '031521_182048_sim_data_vs_SNR_TBCC_53_75_CRC_21_k_64';...
    '031521_182316_sim_data_vs_SNR_TBCC_53_75_CRC_77_k_64';...
    '031521_182449_sim_data_vs_SNR_TBCC_53_75_CRC_143_k_64';...
    '031521_182651_sim_data_vs_SNR_TBCC_53_75_CRC_275_k_64';...
    '031521_182841_sim_data_vs_SNR_TBCC_53_75_CRC_555_k_64';...
    '031521_183058_sim_data_vs_SNR_TBCC_53_75_CRC_1511_k_64';...
    '031521_183348_sim_data_vs_SNR_TBCC_53_75_CRC_2033_k_64'};

% v = 6
fileNames{4} = {'031521_181918_sim_data_vs_SNR_TBCC_133_171_CRC_17_k_64';...
    '031521_182059_sim_data_vs_SNR_TBCC_133_171_CRC_33_k_64';...
    '031521_182328_sim_data_vs_SNR_TBCC_133_171_CRC_75_k_64';...
    '031521_182501_sim_data_vs_SNR_TBCC_133_171_CRC_177_k_64';...
    '031521_182702_sim_data_vs_SNR_TBCC_133_171_CRC_377_k_64';...
    '031521_182854_sim_data_vs_SNR_TBCC_133_171_CRC_505_k_64';...
    '031521_183113_sim_data_vs_SNR_TBCC_133_171_CRC_1275_k_64';...
    '031521_183401_sim_data_vs_SNR_TBCC_133_171_CRC_2561_k_64'};

% v = 7
fileNames{5} = {'031521_181930_sim_data_vs_SNR_TBCC_247_371_CRC_17_k_64';...
    '031521_182111_sim_data_vs_SNR_TBCC_247_371_CRC_21_k_64';...
    '031521_182339_sim_data_vs_SNR_TBCC_247_371_CRC_63_k_64';...
    '031521_182515_sim_data_vs_SNR_TBCC_247_371_CRC_143_k_64';...
    '031521_182714_sim_data_vs_SNR_TBCC_247_371_CRC_357_k_64';...
    '031521_182907_sim_data_vs_SNR_TBCC_247_371_CRC_505_k_64';...
    '031521_183126_sim_data_vs_SNR_TBCC_247_371_CRC_1641_k_64';...
    '031521_183524_sim_data_vs_SNR_TBCC_247_371_CRC_2727_k_64'};

% v = 8
fileNames{6} = {'031521_181942_sim_data_vs_SNR_TBCC_561_753_CRC_17_k_64';...
    '031521_182124_sim_data_vs_SNR_TBCC_561_753_CRC_21_k_64';...
    '031521_182350_sim_data_vs_SNR_TBCC_561_753_CRC_63_k_64';...
    '031521_182544_sim_data_vs_SNR_TBCC_561_753_CRC_177_k_64';...
    '031521_182727_sim_data_vs_SNR_TBCC_561_753_CRC_377_k_64';...
    '031521_182924_sim_data_vs_SNR_TBCC_561_753_CRC_653_k_64';...
    '031521_183150_sim_data_vs_SNR_TBCC_561_753_CRC_1401_k_64';...
    '031521_183540_sim_data_vs_SNR_TBCC_561_753_CRC_2365_k_64'};

% v = 9
fileNames{7} = {'031521_181959_sim_data_vs_SNR_TBCC_1131_1537_CRC_15_k_64';...
    '031521_182135_sim_data_vs_SNR_TBCC_1131_1537_CRC_25_k_64';...
    '031521_182403_sim_data_vs_SNR_TBCC_1131_1537_CRC_63_k_64';...
    '031521_182604_sim_data_vs_SNR_TBCC_1131_1537_CRC_121_k_64';...
    '031521_182742_sim_data_vs_SNR_TBCC_1131_1537_CRC_305_k_64';...
    '031521_182939_sim_data_vs_SNR_TBCC_1131_1537_CRC_777_k_64';...
    '031521_183224_sim_data_vs_SNR_TBCC_1131_1537_CRC_1511_k_64';...
    '031521_183642_sim_data_vs_SNR_TBCC_1131_1537_CRC_2603_k_64'};

% v = 10
fileNames{8} = {'031521_182013_sim_data_vs_SNR_TBCC_2473_3217_CRC_17_k_64';...
    '031521_182147_sim_data_vs_SNR_TBCC_2473_3217_CRC_33_k_64';...
    '031621_134659_sim_data_vs_SNR_TBCC_2473_3217_CRC_63_k_64';...
    '031521_182616_sim_data_vs_SNR_TBCC_2473_3217_CRC_171_k_64';...
    '031521_182800_sim_data_vs_SNR_TBCC_2473_3217_CRC_273_k_64';...
    '031521_183003_sim_data_vs_SNR_TBCC_2473_3217_CRC_631_k_64';...
    '031521_183259_sim_data_vs_SNR_TBCC_2473_3217_CRC_1027_k_64';...
    '031521_183807_sim_data_vs_SNR_TBCC_2473_3217_CRC_2335_k_64'};

c1 = 1;
c2 = 1;

for iter = 1:length(vs)
    v = vs(iter);
    SNR_gaps{iter} = zeros(size(fileNames{iter}, 1), 1);
    Complexities{iter} = zeros(size(fileNames{iter}, 1), 1);
    for ii = 1:size(fileNames{iter}, 1)
        m = ii + 2;
        n = omega*(k + m);
        R = k / n;
        opt_snr = fzero(@(x) rcu(n, R, [0.5;0.5], [-1;1], 10^(-x/10))-target_prob_UE, [1 5]);
        
        fileName = fileNames{iter}{ii};
        load([path, fileName, '.mat'], 'P_UE_maxs', 'SNRs', 'Exp_list_size_maxs','Exp_insertions');
        if iter == 1 && ii == 1
            idx = find(SNRs == 1);
            SNRs = SNRs(idx:end);
            P_UE_maxs = P_UE_maxs(idx:end);
            Exp_list_size_maxs = Exp_list_size_maxs(idx:end);
            Exp_insertions = Exp_insertions(idx:end);
        end
        log_SNRs = log10(P_UE_maxs);
        snr_val = interp1(log_SNRs, SNRs, log10(target_prob_UE));
        SNR_gaps{iter}(ii) = snr_val - opt_snr;
        exp_list_rank = interp1(SNRs, Exp_list_size_maxs, snr_val);
        exp_insertion = (k+m)*exp_list_rank+2^v-1;
%         if all(Exp_insertions > 0) == 1
%             exp_insertion= interp1(SNRs, Exp_insertions, snr_val);
%         end
        Complexities{iter}(ii) = (3*k+3*m+1)*2^v + 3.5*c1*(k+m)*exp_list_rank + ...
            c2*exp_insertion*log2(exp_insertion);
%         Complexities{iter}(ii) = (k+m)*2^v;
    end
end

%%
figure;
semilogx(Complexities{1}, SNR_gaps{1}, '+b'); hold on
semilogx(Complexities{2}, SNR_gaps{2}, 'o'); hold on
semilogx(Complexities{3}, SNR_gaps{3}, '*'); hold on
semilogx(Complexities{4}, SNR_gaps{4}, 'x'); hold on
semilogx(Complexities{5}, SNR_gaps{5}, 'v'); hold on
semilogx(Complexities{6}, SNR_gaps{6}, 'd'); hold on
semilogx(Complexities{7}, SNR_gaps{7}, '^'); hold on
semilogx(Complexities{8}, SNR_gaps{8}, 's'); hold on

legend('$\nu=3\ (13, 17)$',...
    '$\nu=4\ (27, 31)$',...
    '$\nu=5\ (53, 75)$',...
    '$\nu=6\ (133, 171)$',...
    '$\nu=7\ (247, 371)$',...
    '$\nu=8\ (561, 753)$',...
    '$\nu=9\ (1131, 1537)$',...
    '$\nu=10\ (2473, 3217)$',...
    'Location','northeast');

grid on
ylim([-0.5, 3]);
xlabel('Complexity', 'interpreter', 'latex');
ylabel('Gap to the RCU bound (dB)', 'interpreter', 'latex');
% title('Target probability of UE: P_{e,\lambda} = 10^{-4}');

